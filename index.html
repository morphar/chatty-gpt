<!doctype html>
<html class="h-full bg-gray-100">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Generated by tailwindcss CLI -->
  <link href="./css/global.min.css" rel="stylesheet">

  <script type="module">
    import './components/chatty-modal.js'
    import './components/chatty-prompt.js'

    import './views/left-menu.js'
    import './views/settings-view.js'
    import './views/create-chat.js'
    import './views/chat-view.js'
  </script>
</head>

<body class="h-full">

  <!-- Page Container -->

  <div class="h-full">

    <left-menu></left-menu>

    <div class="flex flex-1 flex-col pl-64 h-full">
      <main class="flex-1 h-full">
        <div id="main-content" class="relative h-full overflow-x-hidden overflow-y-auto">

          <!-- content -->

          <create-chat></create-chat>

        </div>
      </main>
    </div>
  </div>

  <chatty-modal id="settings-modal">
    <settings-view></settings-view>
  </chatty-modal>

  <chatty-prompt id="clear-all-prompt">
    <chatty-icon slot="icon" name="trash" class="h-6 w-6 text-red-600"></chatty-icon>
    <span slot="title">Clear all data</span>
    <span slot="description">This will delete your chat history and reset you API key and Organization ID.</span>
    <span slot="ok-label">Clear everything!</span>
    <span slot="cancel-label">Cancel</span>
  </chatty-prompt>

  <script>
    // TODO: Much of this, should be packed into something like a "router".
    // The router should also take care of removing current content and injecting the new view. 
    // A router should also parse and use the URL parameters.

    // Left menu listeners

    document.querySelector('left-menu').addEventListener('settings', (evt) => {
      evt.preventDefault()
      evt.stopPropagation()

      document.querySelector('#settings-modal').setAttribute('visible', true)
    })

    document.querySelector('left-menu').addEventListener('clear', (evt) => {
      evt.preventDefault()
      evt.stopPropagation()

      document.querySelector('#clear-all-prompt').setAttribute('visible', true)
    })

    document.querySelector('left-menu').addEventListener('create-chat', (evt) => {
      evt.preventDefault()
      evt.stopPropagation()

      document.querySelector('#main-content').innerHTML = '<create-chat />'
    })

    document.querySelector('left-menu').addEventListener('chat', (evt) => {
      evt.preventDefault()
      evt.stopPropagation()

      document.querySelector('#main-content').innerHTML = `<chat-view chat-id="${evt.detail}" />`
    })


    // document.querySelector('left-menu').addEventListener('click', (evt) => {
    //   console.log(evt)
    // })

    // Settings and clear listeners

    // Show the settings modal, when no API key has been set
    if (!localStorage.getItem('openai-apikey')) {
      document.querySelector('#settings-modal').setAttribute('visible', true)
    }

    // Close the modal, after saving the settings
    document.querySelector('settings-view').addEventListener('saved', (evt) => {
      document.querySelector('#settings-modal').setAttribute('visible', false)
    })

    // Clear localStorage, update settings view and hide the prompt 
    document.querySelector('chatty-prompt').addEventListener('ok', (evt) => {
      evt.preventDefault()
      evt.stopPropagation()

      localStorage.clear()

      document.querySelector('settings-view').updateView()

      document.querySelector('chatty-prompt').setAttribute('visible', false)
    })

    // "Create chat" listener

    document.querySelector('#main-content').addEventListener('created', (evt) => {
      document.querySelector('left-menu').update()
      document.querySelector('#main-content').innerHTML = `<chat-view chat-id="${evt.detail}" />`
    })

    // Listen for any bubbled update-menu events on main-content
    document.querySelector('#main-content').addEventListener('update-menu', (evt) => {
      document.querySelector('left-menu').update()
    })


  </script>
</body>

</html>